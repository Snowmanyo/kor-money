<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïó¨Ìñâ Í∏∞Î°ù | ÈüìÂúãÊóÖË°åË®òÂ∏≥Êú¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --navy: #1E3A5F;
            --teal: #4DB8AC;
            --teal-dark: #3A9B91;
            --teal-light: #E0F5F3;
            --white: #FFFFFF;
            --text-dark: #2C3E50;
            --text-gray: #7F8C8D;
            --text-light: #BDC3C7;
            --shadow: 0 8px 24px rgba(30, 58, 95, 0.15);
            --shadow-lg: 0 12px 32px rgba(30, 58, 95, 0.2);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(180deg, var(--navy) 0%, #2C4A6F 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
        }

        /* È†ÇÈÉ®ÂçÄÂüü */
        .header {
            background: var(--navy);
            padding: 20px 20px 40px;
            position: relative;
            overflow: hidden;
        }

        .landmarks {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            opacity: 0.1;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"><path fill="%23ffffff" d="M0,60 L100,40 L150,50 L200,30 L250,50 L300,20 L350,40 L400,10 L450,30 L500,50 L550,40 L600,60 L650,50 L700,40 L750,50 L800,30 L850,40 L900,50 L950,60 L1000,50 L1050,40 L1100,50 L1150,60 L1200,50 L1200,120 L0,120 Z"/></svg>');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: bottom;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header-title {
            color: var(--white);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-subtitle {
            color: var(--teal-light);
            font-size: 14px;
            font-weight: 300;
        }

        .hamburger-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 0;
        }

        .hamburger-btn span {
            width: 20px;
            height: 2px;
            background: var(--white);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .hamburger-btn:active {
            transform: scale(0.95);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 85%;
            max-width: 320px;
            height: 100vh;
            background: var(--white);
            z-index: 999;
            transform: translateX(100%);
            transition: all 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
        }

        .sidebar.show {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 20px;
            background: linear-gradient(135deg, var(--navy) 0%, #2C4A6F 100%);
            color: var(--white);
        }

        .sidebar-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: var(--white);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #F0F0F0;
        }

        .sidebar-section-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .user-switch-sidebar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .user-btn-sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 12px;
            border: 2px solid #E8ECF0;
            background: #F8F9FA;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .user-btn-sidebar:hover {
            background: var(--teal-light);
            border-color: var(--teal);
        }

        .user-btn-sidebar.active {
            background: var(--teal);
            border-color: var(--teal);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(77, 184, 172, 0.3);
        }

        .sidebar-menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: none;
            background: #F8F9FA;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            text-align: left;
        }

        .sidebar-menu-item:hover {
            background: var(--teal-light);
            transform: translateX(4px);
        }

        .sidebar-item-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .sidebar-item-desc {
            font-size: 12px;
            color: var(--text-gray);
        }

        .sidebar-footer {
            padding: 20px;
            margin-top: auto;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 0 20px;
            margin-top: -20px;
            position: relative;
            z-index: 2;
        }

        .tab {
            padding: 14px 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 16px 16px 0 0;
            color: var(--white);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab.active {
            background: var(--white);
            color: var(--navy);
            box-shadow: var(--shadow);
        }

        .content {
            background: #F7F9FC;
            min-height: calc(100vh - 200px);
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"],
        textarea,
        select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E8ECF0;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Noto Sans TC', sans-serif;
            transition: all 0.3s ease;
            background: var(--white);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px var(--teal-light);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--teal) 0%, var(--teal-dark) 100%);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(77, 184, 172, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(77, 184, 172, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--teal);
            border: 2px solid var(--teal);
        }

        .btn-secondary:hover {
            background: var(--teal-light);
        }

        .category-grid-horizontal {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .category-option {
            position: relative;
        }

        .category-option input {
            display: none;
        }

        .category-option label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 6px;
            background: #F8F9FA;
            border: 2px solid #E8ECF0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-option input:checked + label {
            background: var(--teal-light);
            border-color: var(--teal);
            transform: scale(1.05);
        }

        .category-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .category-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .currency-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .currency-item {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 12px;
            position: relative;
        }

        .currency-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 6px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .currency-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .currency-symbol {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .currency-input input {
            border: none;
            background: transparent;
            font-size: 18px;
            font-weight: 600;
            padding: 0;
        }

        /* Ë®àÁÆóÊ©ü */
        .calculator {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            padding: 12px;
            z-index: 100;
            width: 200px;
            display: none;
            margin-top: 8px;
        }

        .calculator.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        .calc-display {
            background: #F8F9FA;
            padding: 12px;
            border-radius: 8px;
            text-align: right;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            min-height: 40px;
            word-break: break-all;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .calc-btn {
            padding: 12px;
            border: none;
            background: #F8F9FA;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-btn:hover {
            background: var(--teal-light);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .calc-btn.operator {
            background: var(--teal);
            color: white;
        }

        .calc-btn.equals {
            background: #4CAF50;
            color: white;
        }

        .calc-btn.clear {
            background: #EF4444;
            color: white;
        }

        .calc-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            transition: all 0.2s;
        }

        .calc-icon-btn:hover {
            transform: scale(1.2);
        }

        .stats-card {
            background: linear-gradient(135deg, var(--navy) 0%, #2C4A6F 100%);
            border-radius: 20px;
            padding: 24px;
            color: var(--white);
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '‚Ç©';
            position: absolute;
            right: -20px;
            top: -20px;
            font-size: 120px;
            opacity: 0.05;
            font-weight: 700;
        }

        .stats-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 16px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .payment-option {
            position: relative;
        }

        .payment-option input {
            display: none;
        }

        .payment-option label {
            display: block;
            padding: 12px 8px;
            background: #F8F9FA;
            border: 2px solid #E8ECF0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
        }

        .payment-option input:checked + label {
            background: var(--teal-light);
            border-color: var(--teal);
            color: var(--teal-dark);
        }

        .split-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #F8F9FA;
            border-radius: 12px;
            cursor: pointer;
        }

        .switch {
            position: relative;
            width: 52px;
            height: 28px;
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #CED4DA;
            border-radius: 28px;
            transition: all 0.3s ease;
        }

        .slider:before {
            content: '';
            position: absolute;
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .switch input:checked + .slider {
            background: var(--teal);
        }

        .switch input:checked + .slider:before {
            transform: translateX(24px);
        }

        .split-mode {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .split-mode-option {
            position: relative;
        }

        .split-mode-option input {
            display: none;
        }

        .split-mode-option label {
            display: block;
            padding: 12px;
            background: #F8F9FA;
            border: 2px solid #E8ECF0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .split-mode-option input:checked + label {
            background: var(--teal-light);
            border-color: var(--teal);
            color: var(--teal-dark);
        }

        .split-people {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .person-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--teal-light);
            border-radius: 20px;
            font-size: 14px;
            color: var(--teal-dark);
            font-weight: 500;
            animation: bounceIn 0.4s ease;
        }

        .person-tag button {
            background: none;
            border: none;
            color: var(--teal-dark);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .person-tag button:hover {
            background: var(--teal);
            color: white;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-gray);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            font-weight: 500;
        }

        .expense-card {
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid var(--teal);
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease;
        }

        .expense-card:hover {
            transform: translateX(4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .expense-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .expense-date {
            font-size: 12px;
            color: var(--text-gray);
        }

        .expense-amounts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 12px 0;
            border-top: 1px solid #F0F0F0;
            border-bottom: 1px solid #F0F0F0;
        }

        .amount-item {
            font-size: 14px;
        }

        .amount-label {
            color: var(--text-gray);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .amount-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .expense-menu {
            position: relative;
        }

        .expense-menu-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #F8F9FA;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .expense-menu-btn:hover {
            background: var(--teal-light);
        }

        .expense-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 140px;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .expense-dropdown.show {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .expense-dropdown button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }

        .expense-dropdown button:hover {
            background: var(--teal-light);
        }

        .expense-dropdown button:not(:last-child) {
            border-bottom: 1px solid #F0F0F0;
        }

        .settled-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--teal);
            color: var(--white);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .proxy-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #FFE5B4;
            color: #D97706;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .image-upload-area {
            cursor: pointer;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #E8ECF0;
            border-radius: 16px;
            overflow: hidden;
            background: #F8F9FA;
            transition: all 0.3s ease;
        }

        .image-preview:hover {
            border-color: var(--teal);
            background: var(--teal-light);
        }

        .upload-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .shopping-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease;
        }

        .shopping-card.purchased {
            opacity: 0.6;
        }

        .shopping-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #F8F9FA;
        }

        .shopping-content {
            padding: 16px;
        }

        .shopping-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .shopping-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            flex: 1;
        }

        .shopping-title.purchased {
            text-decoration: line-through;
        }

        .shopping-info {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .shopping-prices {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-dark);
            font-weight: 600;
        }

        .shopping-actions {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
        }

        .btn-purchase {
            padding: 10px;
            border: 2px solid var(--teal);
            background: var(--white);
            color: var(--teal);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-purchase:hover {
            background: var(--teal-light);
        }

        .btn-purchase.purchased {
            background: var(--teal);
            color: var(--white);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border: none;
            background: #F8F9FA;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            background: #FFE5E5;
            color: #E74C3C;
        }

        .btn-icon.edit:hover {
            background: var(--teal-light);
            color: var(--teal);
        }

        .shopping-quantity {
            background: #F8F9FA;
            padding: 12px;
            border-radius: 12px;
            margin: 12px 0;
        }

        .qty-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .qty-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            background: #FFE5B4;
            color: #D97706;
        }

        .qty-badge.complete {
            background: #D1FAE5;
            color: #059669;
        }

        .qty-progress {
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .qty-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--teal) 0%, #6CD9C8 100%);
            transition: width 0.3s ease;
        }

        .qty-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--teal);
            background: var(--white);
            border-radius: 8px;
            color: var(--teal);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: var(--teal);
            color: var(--white);
        }

        .qty-btn:active {
            transform: scale(0.9);
        }

        .qty-actions > span {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            min-width: 30px;
            text-align: center;
        }

        .filter-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .filter-tab {
            padding: 10px;
            border: 2px solid #E8ECF0;
            background: var(--white);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-dark);
        }

        .filter-tab.active {
            background: var(--teal);
            color: var(--white);
            border-color: var(--teal);
        }

        .filter-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .filter-option-btn {
            padding: 10px 8px;
            border: 2px solid #E8ECF0;
            background: #F8F9FA;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .filter-option-btn:hover,
        .filter-option-btn.active {
            background: var(--teal-light);
            border-color: var(--teal);
            color: var(--teal-dark);
        }

        .btn-filter-clear {
            padding: 8px 16px;
            border: none;
            background: #F8F9FA;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-filter-clear:hover {
            background: #E8ECF0;
        }

        .location-filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .location-btn {
            padding: 12px;
            border: 2px solid #E8ECF0;
            background: #F8F9FA;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .location-btn:hover,
        .location-btn.active {
            background: var(--teal-light);
            border-color: var(--teal);
            color: var(--teal-dark);
        }

        .split-card {
            background: var(--teal-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--teal);
        }

        .split-person-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 16px;
        }

        .split-stats {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .split-stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .split-stat-label {
            color: var(--text-gray);
        }

        .split-stat-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .split-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--teal);
        }

        .split-detail-title {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .split-item {
            font-size: 13px;
            color: var(--text-dark);
            margin-bottom: 6px;
            padding-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- È†ÇÈÉ® -->
        <div class="header">
            <div class="landmarks"></div>
            <div class="header-content">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="header-title">
                            üá∞üá∑ Ïó¨Ìñâ Í∏∞Î°ù
                        </div>
                        <div class="header-subtitle">Korean Travel Expense Tracker</div>
                    </div>
                    <button class="hamburger-btn" onclick="toggleSidebar()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Ê®ôÁ±§È†Å -->
        <div class="tabs">
            <button class="tab active" data-tab="expense">Ë®òÂ∏≥</button>
            <button class="tab" data-tab="shopping">Ë≥ºÁâ©</button>
            <button class="tab" data-tab="overview">Á∏ΩË¶Ω</button>
            <button class="tab" data-tab="split">ÂàÜÂ∏≥</button>
        </div>

        <!-- ÂÖßÂÆπÂçÄ -->
        <div class="content">
            <!-- Ë®òÂ∏≥È†ÅÈù¢ -->
            <div class="tab-content active" id="expenseTab">
                <div class="card">
                    <div class="card-title">‚úçÔ∏è <span id="formModeTitle">Êñ∞Â¢ûË®òÂ∏≥</span></div>
                    
                    <div class="form-group">
                        <label class="form-label">Êó•ÊúüÊôÇÈñì</label>
                        <input type="datetime-local" id="datetime">
                    </div>

                    <div class="form-group">
                        <label class="form-label">È†ÖÁõÆÂêçÁ®±</label>
                        <input type="text" id="itemName" placeholder="‰æãÂ¶Ç:ÊòéÊ¥ûÁæéÂ¶ùÂ∫ó">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂàÜÈ°û</label>
                        <div class="category-grid-horizontal">
                            <div class="category-option">
                                <input type="radio" name="category" value="È£ü" id="cat-food" checked>
                                <label for="cat-food">
                                    <div class="category-icon">üçΩÔ∏è</div>
                                    <div class="category-name">È£ü</div>
                                </label>
                            </div>
                            <div class="category-option">
                                <input type="radio" name="category" value="Ë°£" id="cat-cloth">
                                <label for="cat-cloth">
                                    <div class="category-icon">üëï</div>
                                    <div class="category-name">Ë°£</div>
                                </label>
                            </div>
                            <div class="category-option">
                                <input type="radio" name="category" value="‰Ωè" id="cat-hotel">
                                <label for="cat-hotel">
                                    <div class="category-icon">üè®</div>
                                    <div class="category-name">‰Ωè</div>
                                </label>
                            </div>
                            <div class="category-option">
                                <input type="radio" name="category" value="Ë°å" id="cat-trans">
                                <label for="cat-trans">
                                    <div class="category-icon">üöá</div>
                                    <div class="category-name">Ë°å</div>
                                </label>
                            </div>
                            <div class="category-option">
                                <input type="radio" name="category" value="Ê®Ç" id="cat-fun">
                                <label for="cat-fun">
                                    <div class="category-icon">üé™</div>
                                    <div class="category-name">Ê®Ç</div>
                                </label>
                            </div>
                            <div class="category-option">
                                <input type="radio" name="category" value="ÂÑ≤ÂÄº" id="cat-topup">
                                <label for="cat-topup">
                                    <div class="category-icon">üí∞</div>
                                    <div class="category-name">ÂÑ≤ÂÄº</div>
                                </label>
                            </div>
                            <div class="category-option">
                                <input type="radio" name="category" value="ÂÖ∂‰ªñ" id="cat-other">
                                <label for="cat-other">
                                    <div class="category-icon">üì¶</div>
                                    <div class="category-name">ÂÖ∂‰ªñ</div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÈáëÈ°ç</label>
                        <div class="currency-grid">
                            <div class="currency-item">
                                <div class="currency-label">
                                    ÈüìÂÖÉ KRW
                                    <button type="button" class="calc-icon-btn" onclick="toggleCalculator('krw')">üßÆ</button>
                                </div>
                                <div class="currency-input">
                                    <span class="currency-symbol">‚Ç©</span>
                                    <input type="number" id="krw" placeholder="0">
                                </div>
                                <div class="calculator" id="calc-krw">
                                    <div class="calc-display" id="calc-display-krw">0</div>
                                    <div class="calc-buttons">
                                        <button class="calc-btn" onclick="calcInput('krw', '7')">7</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '8')">8</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '9')">9</button>
                                        <button class="calc-btn operator" onclick="calcInput('krw', '/')">√∑</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '4')">4</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '5')">5</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '6')">6</button>
                                        <button class="calc-btn operator" onclick="calcInput('krw', '*')">√ó</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '1')">1</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '2')">2</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '3')">3</button>
                                        <button class="calc-btn operator" onclick="calcInput('krw', '-')">Ôºç</button>
                                        <button class="calc-btn" onclick="calcInput('krw', '0')">0</button>
                                        <button class="calc-btn clear" onclick="calcClear('krw')">C</button>
                                        <button class="calc-btn equals" onclick="calcEquals('krw')">=</button>
                                        <button class="calc-btn operator" onclick="calcInput('krw', '+')">Ôºã</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="currency-item">
                                <div class="currency-label">
                                    Âè∞Âπ£ TWD
                                    <button type="button" class="calc-icon-btn" onclick="toggleCalculator('twd')">üßÆ</button>
                                </div>
                                <div class="currency-input">
                                    <span class="currency-symbol">NT$</span>
                                    <input type="number" id="twd" placeholder="0">
                                </div>
                                <div class="calculator" id="calc-twd">
                                    <div class="calc-display" id="calc-display-twd">0</div>
                                    <div class="calc-buttons">
                                        <button class="calc-btn" onclick="calcInput('twd', '7')">7</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '8')">8</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '9')">9</button>
                                        <button class="calc-btn operator" onclick="calcInput('twd', '/')">√∑</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '4')">4</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '5')">5</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '6')">6</button>
                                        <button class="calc-btn operator" onclick="calcInput('twd', '*')">√ó</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '1')">1</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '2')">2</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '3')">3</button>
                                        <button class="calc-btn operator" onclick="calcInput('twd', '-')">Ôºç</button>
                                        <button class="calc-btn" onclick="calcInput('twd', '0')">0</button>
                                        <button class="calc-btn clear" onclick="calcClear('twd')">C</button>
                                        <button class="calc-btn equals" onclick="calcEquals('twd')">=</button>
                                        <button class="calc-btn operator" onclick="calcInput('twd', '+')">Ôºã</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‰ªòÊ¨æÊñπÂºè</label>
                        <div class="payment-grid">
                            <div class="payment-option">
                                <input type="radio" name="payment" value="ÁèæÈáë" id="pay-cash" checked>
                                <label for="pay-cash">ÁèæÈáë</label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" name="payment" value="‰ø°Áî®Âç°" id="pay-card">
                                <label for="pay-card">‰ø°Áî®Âç°</label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" name="payment" value="ÈõªÂ≠êÊîØ‰ªò" id="pay-epay">
                                <label for="pay-epay">ÈõªÂ≠êÊîØ‰ªò</label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" name="payment" value="TM/WP" id="pay-tm">
                                <label for="pay-tm">TM/WP</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="split-toggle" onclick="toggleSplit()">
                            <span style="font-weight: 600; color: var(--text-dark);">üë• ÈúÄË¶ÅÂàÜÂ∏≥/‰ª£Ë≥º</span>
                            <div class="switch">
                                <input type="checkbox" id="enableSplit">
                                <span class="slider"></span>
                            </div>
                        </div>
                        <div id="splitContent" style="display: none;">
                            <!-- Á¨¨‰∏ÄÂ±§:ÂàÜÂ∏≥/‰ª£Ë≥ºÈÅ∏Êìá -->
                            <div class="split-mode">
                                <div class="split-mode-option">
                                    <input type="radio" name="mainMode" value="split" id="main-split" checked onchange="toggleSplitSubMode()">
                                    <label for="main-split">üí∞ ÂàÜÂ∏≥</label>
                                </div>
                                <div class="split-mode-option">
                                    <input type="radio" name="mainMode" value="proxy" id="main-proxy" onchange="toggleSplitSubMode()">
                                    <label for="main-proxy">üéÅ ‰ª£Ë≥º</label>
                                </div>
                            </div>
                            
                            <!-- Á¨¨‰∫åÂ±§:ÂàÜÂ∏≥ÊôÇÁöÑÂπ≥ÂàÜ/Ëá™Ë®ÇÈÅ∏Êìá -->
                            <div id="splitSubMode" style="margin-top: 12px;">
                                <div class="split-mode" style="grid-template-columns: repeat(2, 1fr);">
                                    <div class="split-mode-option">
                                        <input type="radio" name="splitMethod" value="equal" id="method-equal" checked>
                                        <label for="method-equal">Âπ≥ÂàÜ</label>
                                    </div>
                                    <div class="split-mode-option">
                                        <input type="radio" name="splitMethod" value="custom" id="method-custom">
                                        <label for="method-custom">Ëá™Ë®ÇÈáëÈ°ç</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <input type="text" id="personName" placeholder="Ëº∏ÂÖ•ÂßìÂêç" style="flex: 1;">
                                <button class="btn-secondary" onclick="addPerson()" style="width: auto; padding: 14px 24px;">Êñ∞Â¢û</button>
                            </div>
                            <div class="split-people" id="splitPeople"></div>
                            <!-- ÊØè‰∫∫ÈáëÈ°çËº∏ÂÖ•ÂçÄÔºàËá™Ë®Ç / ‰ª£Ë≥ºÁî®Ôºâ -->
                            <div id="splitAllocationsWrap" style="display:none; margin-top: 12px;">
                                <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; line-height: 1.4;">
                                üí° ÈÄôË£°Â°´„ÄåÂ∞çÊñπÂêÑËá™Êáâ‰ªò„ÄçÈáëÈ°çÔºõÁ≥ªÁµ±ÊúÉËá™ÂãïÁÆó‰Ω†Ë¶ÅË≤†ÊìîÂ§öÂ∞ëÔºà= Á∏ΩÈ°ç - Â∞çÊñπÂêàË®àÔºâ
                                </div>
                                <div id="splitAllocations"></div>
                            </div>
                            
                            <!-- Âç≥ÊôÇË®àÁÆóÈ†êË¶Ω -->
                            <div id="splitPreview" style="margin-top: 12px; font-size: 13px; color: var(--text-gray); line-height: 1.5;"></div>
                            
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª (ÈÅ∏Â°´)</label>
                        <textarea id="note" rows="3" placeholder="Ë®òÈåÑÂøÉÊÉÖÊàñÂÖ∂‰ªñË≥áË®ä..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="saveExpense()">üíæ ÂÑ≤Â≠òË®òÂ∏≥</button>
                </div>
            </div>

            <!-- Ë≥ºÁâ©Ê∏ÖÂñÆÈ†ÅÈù¢ -->
            <div class="tab-content" id="shoppingTab">
                <div class="card">
                    <div class="card-title">üõçÔ∏è <span id="shoppingFormModeTitle">Êñ∞Â¢ûÂïÜÂìÅ</span></div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂïÜÂìÅÂúñÁâá (ÈÅ∏Â°´)</label>
                        <div class="image-upload-area" onclick="document.getElementById('shoppingImage').click()">
                            <input type="file" id="shoppingImage" accept="image/*" style="display: none;" onchange="previewShoppingImage()">
                            <div id="imagePreview" class="image-preview">
                                <div class="upload-placeholder">
                                    <span style="font-size: 48px;">üì∑</span>
                                    <div style="margin-top: 8px; font-size: 14px;">ÈªûÊìä‰∏äÂÇ≥ÂúñÁâá</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂïÜÂìÅÂêçÁ®± *</label>
                        <input type="text" id="shoppingItem" placeholder="‰æãÂ¶Ç:CEZANNE 101ËôüÂîáËÜè" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ë≥ºË≤∑Âú∞Èªû</label>
                        <input type="text" id="shoppingLocation" placeholder="‰æãÂ¶Ç:ÊòéÊ¥û Olive Young">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÈúÄË≥ºË≤∑Êï∏Èáè</label>
                        <input type="number" id="shoppingTargetQty" placeholder="1" min="1" value="1">
                        <div style="font-size: 12px; color: var(--text-gray); margin-top: 4px;">üí° ‰πãÂæåÂèØ‰ª•Áõ¥Êé•Âú®ÂïÜÂìÅÂç°Áâá‰∏äË™øÊï¥Êï∏Èáè</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">È†êË®àÂñÆÂÉπ</label>
                        <div class="currency-grid">
                            <div class="currency-item">
                                <div class="currency-label">ÈüìÂÖÉ KRW</div>
                                <div class="currency-input">
                                    <span class="currency-symbol">‚Ç©</span>
                                    <input type="number" id="shoppingKRW" placeholder="0">
                                </div>
                            </div>
                            <div class="currency-item">
                                <div class="currency-label">Âè∞Âπ£ TWD</div>
                                <div class="currency-input">
                                    <span class="currency-symbol">NT$</span>
                                    <input type="number" id="shoppingTWD" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <textarea id="shoppingNote" rows="2" placeholder="È°èËâ≤„ÄÅË¶èÊ†ºÁ≠â..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addShoppingItem()">‚ûï Âä†ÂÖ•Ë≥ºÁâ©Ê∏ÖÂñÆ</button>
                </div>

                <div class="stats-card" id="shoppingStatsCard" style="display: none; margin-top: 20px;">
                    <div class="stats-title">üìä Ë≥ºÁâ©Áµ±Ë®à</div>
                    <div class="stats-grid" id="shoppingStats"></div>
                </div>

                <div class="card" id="locationFilterCard" style="display: none; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--text-dark);">üîç ÊåâÂú∞ÈªûÁØ©ÈÅ∏</div>
                        <button class="btn-filter-clear" onclick="clearShoppingFilter()" id="clearShoppingBtn" style="display: none;">‚úï Ê∏ÖÈô§</button>
                    </div>
                    <div class="location-filters" id="locationFilters"></div>
                </div>

                <div id="shoppingList" style="margin-top: 20px;"></div>
            </div>

            <!-- Á∏ΩË¶ΩÈ†ÅÈù¢ -->
            <div class="tab-content" id="overviewTab">
                <!-- 1. Á∏ΩÊîØÂá∫Áµ±Ë®à -->
                <div class="stats-card">
                    <div class="stats-title">üìä ÊàëÁöÑÁ∏ΩÊîØÂá∫ (‰∏çÂê´ÂÑ≤ÂÄº)</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">ÈüìÂÖÉ</div>
                            <div class="stat-value" id="totalKRW">‚Ç©0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Âè∞Âπ£</div>
                            <div class="stat-value" id="totalTWD">NT$0</div>
                        </div>
                    </div>
                </div>

                <!-- 2. ÂàÜÈ°ûÊîØÂá∫Áµ±Ë®à -->
                <div class="card" style="margin-top: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: var(--text-dark);">üìä ÂàÜÈ°ûÊîØÂá∫Áµ±Ë®à</div>
                        <button onclick="togglePieChart()" style="padding: 8px 16px; background: var(--teal-light); border: 2px solid var(--teal); border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--teal-dark); cursor: pointer; transition: all 0.3s;">
                            üìà ÂúìÈ§ÖÂúñ
                        </button>
                    </div>
                    
                    <!-- ÂúìÈ§ÖÂúñ (È†êË®≠Èö±Ëóè) -->
                    <div id="pieChartContainer" style="display: none; margin-bottom: 20px; padding: 20px; background: #F8F9FA; border-radius: 12px;">
                        <canvas id="categoryPieChart" width="280" height="280"></canvas>
                    </div>
                    
                    <!-- ÂàÜÈ°ûÂç°Áâá Ê©´Âêë -->
                    <div id="categoryStats"></div>
                </div>

                <!-- 3. ÁØ©ÈÅ∏Ë®òÂ∏≥ -->
                <div class="card" style="margin-top: 16px;">
                    <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 12px;">üîç ÁØ©ÈÅ∏Ë®òÂ∏≥</div>
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="switchFilter('all')">ÂÖ®ÈÉ®</button>
                        <button class="filter-tab" onclick="switchFilter('category')">ÂàÜÈ°û</button>
                        <button class="filter-tab" onclick="switchFilter('date')">Êó•Êúü</button>
                        <button class="filter-tab" onclick="switchFilter('payment')">‰ªòÊ¨æ</button>
                    </div>
                    
                    <div id="filterContent" style="margin-top: 16px;"></div>
                    
                    <button class="btn-filter-clear" onclick="clearExpenseFilter()" id="clearExpenseBtn" style="display: none; margin-top: 12px;">
                        ‚úï Ê∏ÖÈô§ÁØ©ÈÅ∏
                    </button>
                </div>

                <!-- 4. Ë®òÂ∏≥ÂàóË°® -->
                <div id="expenseList" style="margin-top: 20px;"></div>
            </div>

            <!-- ÂàÜÂ∏≥Áµ±Ë®àÈ†ÅÈù¢ -->
            <div class="tab-content" id="splitTab">
                <div id="splitReportContent"></div>
            </div>
        </div>
    </div>

    <!-- ÂÅ¥ÈÇäÊ¨ÑÈÅÆÁΩ© -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- ÂÅ¥ÈÇäÊ¨Ñ -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 28px;">üë§</div>
                <div>
                    <div style="font-size: 18px; font-weight: 700;" id="sidebarUserName">Chi</div>
                    <div style="font-size: 13px; opacity: 0.8;">Áï∂Ââç‰ΩøÁî®ËÄÖ</div>
                </div>
            </div>
            <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">ÂàáÊèõ‰ΩøÁî®ËÄÖ</div>
            <div class="user-switch-sidebar">
                <button class="user-btn-sidebar active" data-user="Chi" onclick="switchUser('Chi')">
                    <span style="font-size: 24px;">üë§</span>
                    <span>Chi</span>
                </button>
                <button class="user-btn-sidebar" data-user="Jhen" onclick="switchUser('Jhen')">
                    <span style="font-size: 24px;">üë§</span>
                    <span>Jhen</span>
                </button>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Ë≥áÊñôÁÆ°ÁêÜ</div>
            <button class="sidebar-menu-item" onclick="uploadToCloud(); closeSidebar();">
                <span style="font-size: 24px;">‚òÅÔ∏è</span>
                <div>
                    <div class="sidebar-item-title">‰∏äÂÇ≥Èõ≤Á´Ø</div>
                    <div class="sidebar-item-desc">ÂêåÊ≠•Âà∞ Google Ë©¶ÁÆóË°®</div>
                </div>
            </button>
            <button class="sidebar-menu-item" onclick="downloadFromCloud(); closeSidebar();">
                <span style="font-size: 24px;">‚¨á</span>
                <div>
                    <div class="sidebar-item-title">‰∏ãËºâÈõ≤Á´Ø</div>
                    <div class="sidebar-item-desc">ÂæûË©¶ÁÆóË°®ËºâÂÖ•Ë≥áÊñô</div>
                </div>
            </button>
            <button class="sidebar-menu-item" onclick="exportToExcel(); closeSidebar();">
                <span style="font-size: 24px;">üì•</span>
                <div>
                    <div class="sidebar-item-title">ÂåØÂá∫ Excel</div>
                    <div class="sidebar-item-desc">‰∏ãËºâ CSV Ê™îÊ°à</div>
                </div>
            </button>
        </div>

        <div class="sidebar-footer">
            <div style="font-size: 12px; color: var(--text-gray); text-align: center;">
                ÈüìÂúãÊóÖË°åË®òÂ∏≥Êú¨ v5.0<br>
                üá∞üá∑ Ïó¨Ìñâ Í∏∞Î°ù
            </div>
        </div>
    </div>


    <script>
        // ========== ÂÖ®ÂüüËÆäÊï∏ ==========
        const API_URL = 'https://script.google.com/macros/s/AKfycbwg73REqKMTqtaBXs-IlAmKXkpx1qOv0l5mMiXNSAk9ZiOjiip8CE8g1yKcAYGLzlvO/exec';
        
        let currentUser = localStorage.getItem('currentUser') || 'Chi';
        let expenses = [];
        let splitPeople = [];
        let splitAllocations = {}; // { [name]: { krw: number, twd: number } }
        let shoppingList = [];
        let currentImageData = null;
        let currentExpenseFilter = null;
        let currentShoppingFilter = null;
        let isSyncing = false;
        let editingExpenseId = null;
        let editingShoppingId = null;

        // ========== Ë®àÁÆóÊ©üÂäüËÉΩ ==========
        
        let calcState = {
            krw: { display: '0' },
            twd: { display: '0' }
        };

        function toggleCalculator(currency) {
            const calc = document.getElementById(`calc-${currency}`);
            const allCalcs = document.querySelectorAll('.calculator');
            
            allCalcs.forEach(c => {
                if (c.id !== `calc-${currency}`) c.classList.remove('show');
            });
            
            calc.classList.toggle('show');
            
            if (calc.classList.contains('show')) {
                calcClear(currency);
            }
        }

        function calcInput(currency, value) {
            const state = calcState[currency];
            
            if (state.display === '0') {
                state.display = value;
            } else {
                state.display += value;
            }
            
            document.getElementById(`calc-display-${currency}`).textContent = state.display;
        }

        function calcClear(currency) {
            calcState[currency] = { display: '0' };
            document.getElementById(`calc-display-${currency}`).textContent = '0';
        }

        function calcEquals(currency) {
            const state = calcState[currency];
            try {
                const result = eval(state.display);
                const roundedResult = Math.round(result);
                state.display = String(roundedResult);
                document.getElementById(`calc-display-${currency}`).textContent = roundedResult;
                
                document.getElementById(currency).value = roundedResult;
                
                setTimeout(() => {
                    document.getElementById(`calc-${currency}`).classList.remove('show');
                }, 500);
            } catch (e) {
                state.display = 'Error';
                document.getElementById(`calc-display-${currency}`).textContent = 'Error';
                setTimeout(() => {
                    calcClear(currency);
                }, 1000);
            }
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.currency-item') && !e.target.closest('.calculator')) {
                document.querySelectorAll('.calculator').forEach(calc => {
                    calc.classList.remove('show');
                });
            }
            
            if (!e.target.closest('.expense-menu')) {
                document.querySelectorAll('.expense-dropdown').forEach(m => m.classList.remove('show'));
            }
        });

        // ========== ‰ΩøÁî®ËÄÖÂàáÊèõ ==========
        
        function switchUser(userName) {
            if (currentUser === userName) {
                closeSidebar();
                return;
            }
            
            saveToStorage();
            saveShopping();
            
            currentUser = userName;
            localStorage.setItem('currentUser', userName);
            
            document.getElementById('sidebarUserName').textContent = userName;
            
            document.querySelectorAll('.user-btn-sidebar').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.user === userName);
            });
            
            loadExpenses();
            loadShopping();
            
            renderExpenses();
            renderShopping();
            updateLocationFilters();
            
            showToast(`ÂàáÊèõÂà∞ ${userName} ÁöÑË®òÂ∏≥Êú¨`);
            
            closeSidebar();
        }

        // ========== ÂÅ¥ÈÇäÊ¨ÑÂäüËÉΩ ==========
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }

        // ========== Èõ≤Á´ØÂêåÊ≠•ÂäüËÉΩ ==========
        
        async function uploadToCloud() {
            if (isSyncing) return;
            
            isSyncing = true;
            showSyncStatus(`‰∏äÂÇ≥ ${currentUser} ÁöÑË≥áÊñô‰∏≠...`, 'uploading');
            
            try {
                const shoppingForCloud = shoppingList.map(item => ({
                    ...item,
                    image: item.image ? 'ÊúâÂúñÁâá' : null
                }));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'syncAll',
                        userId: currentUser,
                        expenses: expenses,
                        shopping: shoppingForCloud
                    })
                });
                
                showSyncStatus(`‚úÖ ${currentUser} ÁöÑË≥áÊñô‰∏äÂÇ≥ÊàêÂäü!`, 'success');
                
            } catch (error) {
                console.error('‰∏äÂÇ≥Â§±Êïó:', error);
                showSyncStatus('‚ùå ‰∏äÂÇ≥Â§±Êïó', 'error');
            } finally {
                isSyncing = false;
            }
        }
        
        async function downloadFromCloud() {
            if (isSyncing) return;
            
            isSyncing = true;
            showSyncStatus(`‰∏ãËºâ ${currentUser} ÁöÑË≥áÊñô‰∏≠...`, 'downloading');
            
            try {
                const response = await fetch(API_URL + `?action=getAll&userId=${currentUser}`, {
                    method: 'GET',
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const localImages = {};
                    shoppingList.forEach(item => {
                        if (item.image && item.image !== 'ÊúâÂúñÁâá') {
                            localImages[item.id] = item.image;
                        }
                    });
                    
                    expenses = data.expenses || [];
                    shoppingList = (data.shopping || []).map(item => ({
                        ...item,
                        image: localImages[item.id] || null
                    }));
                    
                    saveToStorage();
                    saveShopping();
                    
                    renderExpenses();
                    renderShopping();
                    updateLocationFilters();
                    
                    showSyncStatus(`‚úÖ ${currentUser} ÁöÑË≥áÊñô‰∏ãËºâÊàêÂäü! (${expenses.length}Á≠ÜË®òÂ∏≥, ${shoppingList.length}È†ÖË≥ºÁâ©)`, 'success');
                } else {
                    showSyncStatus('‚ùå ‰∏ãËºâÂ§±Êïó: ' + data.message, 'error');
                }
                
            } catch (error) {
                console.error('‰∏ãËºâÂ§±Êïó:', error);
                showSyncStatus('‚ùå ‰∏ãËºâÂ§±Êïó', 'error');
            } finally {
                isSyncing = false;
            }
        }
        
        function showSyncStatus(message, type) {
            const oldStatus = document.getElementById('syncStatus');
            if (oldStatus) oldStatus.remove();
            
            const status = document.createElement('div');
            status.id = 'syncStatus';
            status.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                border-radius: 50px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideDown 0.3s ease;
                white-space: nowrap;
            `;
            
            if (type === 'uploading' || type === 'downloading') {
                status.style.background = 'var(--teal)';
                status.style.color = 'white';
                status.innerHTML = `
                    <span style="display: inline-block; animation: spin 1s linear infinite;">‚ü≥</span>
                    ${message}
                `;
            } else if (type === 'success') {
                status.style.background = '#4CAF50';
                status.style.color = 'white';
                status.textContent = message;
            } else if (type === 'error') {
                status.style.background = '#E74C3C';
                status.style.color = 'white';
                status.textContent = message;
            }
            
            document.body.appendChild(status);
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.remove();
                }, 3000);
            }
        }

        // ========== Ê®ôÁ±§ÂàáÊèõ ==========

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const tabName = this.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
                
                if (tabName === 'overview') {
                    renderExpenses();
                } else if (tabName === 'shopping') {
                    renderShopping();
                    updateLocationFilters();
                } else if (tabName === 'split') {
                    renderSplitReport();
                }
            });
        });

        // ========== ÂàùÂßãÂåñ ==========
        
        function init() {
            document.getElementById('sidebarUserName').textContent = currentUser;
            
            document.querySelectorAll('.user-btn-sidebar').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.user === currentUser);
            });
            
            loadExpenses();
            loadShopping();
            setCurrentDateTime();
        }

        function setCurrentDateTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = new Date(now - offset).toISOString().slice(0, 16);
            document.getElementById('datetime').value = localISOTime;
        }

        // ========== Ë®òÂ∏≥ÂäüËÉΩ ==========
        
        function toggleSplit() {
            const checkbox = document.getElementById('enableSplit');
            checkbox.checked = !checkbox.checked;
            document.getElementById('splitContent').style.display = checkbox.checked ? 'block' : 'none';
            
            if (checkbox.checked && splitPeople.length === 0) {
                const otherPerson = currentUser === 'Chi' ? 'Jhen' : 'Chi';
                splitPeople.push(otherPerson);
                ensureAllocation(otherPerson);
                renderSplitPeople();
                renderSplitAllocations();
                updateSplitPreview();

            }
        }

        function toggleSplitSubMode() {
            const mainMode = document.querySelector('input[name="mainMode"]:checked')?.value || 'split';
            const subMode = document.getElementById('splitSubMode');

            if (mainMode === 'proxy') {
                // ‚úÖ ‰ª£Ë≥ºÔºö‰∏çÈúÄË¶ÅÂπ≥ÂàÜÔºåÂº∑Âà∂Áî® custom
                subMode.style.display = 'none';
                const customRadio = document.getElementById('method-custom');
                if (customRadio) customRadio.checked = true;
            } else {
                // ÂàÜÂ∏≥ÔºöÂèØÂπ≥ÂàÜ/Ëá™Ë®Ç
                subMode.style.display = 'block';
            }

            renderSplitAllocations();
            updateSplitPreview();
        }

        function getMyShareFromCurrentInput() {
    const totalKRW = Number(document.getElementById('krw').value) || 0;
    const totalTWD = Number(document.getElementById('twd').value) || 0;

    const enabled = document.getElementById('enableSplit').checked;
    if (!enabled || splitPeople.length === 0) {
        return { myKRW: totalKRW, myTWD: totalTWD, otherKRW: 0, otherTWD: 0 };
    }

    const mainMode = document.querySelector('input[name="mainMode"]:checked')?.value || 'split';
    const splitMethod = document.querySelector('input[name="splitMethod"]:checked')?.value || 'equal';

    if (mainMode === 'split' && splitMethod === 'equal') {
        const denom = splitPeople.length + 1;
        const myKRW = denom > 0 ? totalKRW / denom : 0;
        const myTWD = denom > 0 ? totalTWD / denom : 0;
        const otherKRW = totalKRW - myKRW;
        const otherTWD = totalTWD - myTWD;
        return { myKRW, myTWD, otherKRW, otherTWD };
    }

    // proxy Êàñ split+customÔºöÁî®ÊØè‰∫∫Ëº∏ÂÖ•ÈáëÈ°çÂä†Á∏Ω
    let otherKRW = 0;
    let otherTWD = 0;
    splitPeople.forEach(p => {
        const a = splitAllocations[p] || { krw: 0, twd: 0 };
        otherKRW += Number(a.krw) || 0;
        otherTWD += Number(a.twd) || 0;
    });

    // ‚úÖ Èò≤ÂëÜÔºöÂ∞çÊñπÂêàË®à‰∏çËÉΩË∂ÖÈÅéÁ∏ΩÈ°çÔºàË∂ÖÈÅéÂ∞±Ë¶ñË¶∫ÊèêÈÜíÔºå‰ΩÜ‰∏çÁ°¨ÊîπÔºâ
    const myKRW = totalKRW - otherKRW;
    const myTWD = totalTWD - otherTWD;

    return { myKRW, myTWD, otherKRW, otherTWD };
}

    function updateSplitPreview() {
        const preview = document.getElementById('splitPreview');
        if (!preview) return;

        const enabled = document.getElementById('enableSplit').checked;

        if (!enabled) {
            preview.innerHTML = '';
            return;
        }

        if (splitPeople.length === 0) {
            preview.innerHTML = 'üë• Ë´ãÂÖàÊñ∞Â¢ûÂàÜÂ∏≥/‰ª£Ë≥ºÂ∞çË±°';
            return;
        }

        const mainMode = document.querySelector('input[name="mainMode"]:checked')?.value || 'split';
        const splitMethod = document.querySelector('input[name="splitMethod"]:checked')?.value || 'equal';

        const totalKRW = Number(document.getElementById('krw').value) || 0;
        const totalTWD = Number(document.getElementById('twd').value) || 0;

        const { myKRW, myTWD, otherKRW, otherTWD } = getMyShareFromCurrentInput();

        const overKRW = myKRW < 0;
        const overTWD = myTWD < 0;

        const title = (mainMode === 'proxy') ? 'üéÅ ‰ª£Ë≥º' : (splitMethod === 'equal' ? 'üë• ÂàÜÂ∏≥„ÉªÂπ≥ÂàÜ' : 'üë• ÂàÜÂ∏≥„ÉªËá™Ë®Ç');

        preview.innerHTML = `
        ‚úÖ ${title}<br>
        Á∏ΩÈ°çÔºö‚Ç©${Math.round(totalKRW).toLocaleString()} / NT$${Math.round(totalTWD).toLocaleString()}<br>
        Â∞çÊñπÂêàË®àÔºö‚Ç©${Math.round(otherKRW).toLocaleString()} / NT$${Math.round(otherTWD).toLocaleString()}<br>
        <b style="color:${(overKRW || overTWD) ? '#E74C3C' : 'var(--text-dark)'}">
            ‰Ω†Ë≤†ÊìîÔºö‚Ç©${Math.round(myKRW).toLocaleString()} / NT$${Math.round(myTWD).toLocaleString()}
        </b>
        ${(overKRW || overTWD) ? `<div style="margin-top:6px; color:#E74C3C;">‚ö†Ô∏è Â∞çÊñπÂêàË®à‰∏çËÉΩË∂ÖÈÅéÁ∏ΩÈ°ç</div>` : ''}
        `;
    }


        function addPerson() {
            const input = document.getElementById('personName');
            const name = input.value.trim();
            
            if (name && !splitPeople.includes(name)) {
                splitPeople.push(name);
                ensureAllocation(name);
                renderSplitAllocations();
                updateSplitPreview();
                renderSplitPeople();
                input.value = '';
            }
        }

        function removePerson(name) {
            splitPeople = splitPeople.filter(p => p !== name);
            delete splitAllocations[name];
            renderSplitAllocations();
            updateSplitPreview();
            renderSplitPeople();
        }

        function renderSplitPeople() {
            const container = document.getElementById('splitPeople');
            container.innerHTML = splitPeople.map(name => `
                <div class="person-tag">
                    ${name}
                    <button onclick="removePerson('${name}')">√ó</button>
                </div>
            `).join('');
        }

        function ensureAllocation(name) {
                if (!splitAllocations[name]) {
                    splitAllocations[name] = { krw: 0, twd: 0 };
                }
            }

            function renderSplitAllocations() {
                const wrap = document.getElementById('splitAllocationsWrap');
                const container = document.getElementById('splitAllocations');

                if (!wrap || !container) return;

                const enabled = document.getElementById('enableSplit').checked;
                if (!enabled || splitPeople.length === 0) {
                    wrap.style.display = 'none';
                    container.innerHTML = '';
                    return;
                }

                const mainMode = document.querySelector('input[name="mainMode"]:checked')?.value || 'split';
                const splitMethod = document.querySelector('input[name="splitMethod"]:checked')?.value || 'equal';

                // ‚úÖ ‰ª£Ë≥º‰∏ÄÂÆöË¶ÅËÉΩÂ°´„ÄåÊØè‰∫∫‰∏çÂêåÈáëÈ°ç„ÄçÔºõÂàÜÂ∏≥Âè™Êúâ custom ÊâçÈúÄË¶ÅÊØè‰∫∫Ëº∏ÂÖ•
                const shouldShow = (mainMode === 'proxy') || (mainMode === 'split' && splitMethod === 'custom');
                wrap.style.display = shouldShow ? 'block' : 'none';

                if (!shouldShow) {
                    container.innerHTML = '';
                    return;
                }

                // Á¢∫‰øùÊØèÂÄã‰∫∫ÈÉΩÊúâ allocation
                splitPeople.forEach(ensureAllocation);

                container.innerHTML = splitPeople.map(name => {
                    const a = splitAllocations[name] || { krw: 0, twd: 0 };
                    return `
                    <div class="currency-item" style="margin-bottom: 10px;">
                        <div class="currency-label">üë§ ${name} Êáâ‰ªò</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="currency-input" style="background:#fff; border:2px solid #E8ECF0; border-radius:12px; padding:12px 14px;">
                            <span class="currency-symbol">‚Ç©</span>
                            <input type="number" value="${a.krw || 0}" min="0"
                            style="border:none; background:transparent; width:100%; font-size:16px; font-weight:600;"
                            oninput="setPersonAllocation('${name}', 'krw', this.value)">
                        </div>
                        <div class="currency-input" style="background:#fff; border:2px solid #E8ECF0; border-radius:12px; padding:12px 14px;">
                            <span class="currency-symbol">NT$</span>
                            <input type="number" value="${a.twd || 0}" min="0"
                            style="border:none; background:transparent; width:100%; font-size:16px; font-weight:600;"
                            oninput="setPersonAllocation('${name}', 'twd', this.value)">
                        </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            function setPersonAllocation(name, currency, value) {
                ensureAllocation(name);
                const v = Math.max(0, Number(value) || 0);
                splitAllocations[name][currency] = v;
                updateSplitPreview();
            }


        function saveExpense() {
            const mainMode = document.querySelector('input[name="mainMode"]:checked').value;
            let splitMethod = null;

            if (mainMode === 'proxy') {
                splitMethod = 'custom';
            } else {
                splitMethod = document.querySelector('input[name="splitMethod"]:checked').value;
            }

        
        const expense = {
            id: editingExpenseId || Date.now(),
            datetime: document.getElementById('datetime').value,
            itemName: document.getElementById('itemName').value.trim(),
            category: document.querySelector('input[name="category"]:checked').value,
            krw: parseFloat(document.getElementById('krw').value) || 0,
            twd: parseFloat(document.getElementById('twd').value) || 0,
            payment: document.querySelector('input[name="payment"]:checked').value,
            split: document.getElementById('enableSplit').checked,
            splitMode: mainMode,  // 'split' Êàñ 'proxy'
            splitMethod: splitMethod,  // 'equal' Êàñ 'custom' (Âè™Âú® split Ê®°ÂºèÊúâÂÄº)
            splitPeople: [...splitPeople],
            splitAllocations: JSON.parse(JSON.stringify(splitAllocations)), // Ê∑±Êã∑Ë≤ùÈÅøÂÖçË¢´ÂæåÁ∫åÊîπÂà∞
            note: document.getElementById('note').value.trim(),
            settled: false
        };

            if (!expense.itemName) {
                showToast('Ë´ãÂ°´ÂØ´È†ÖÁõÆÂêçÁ®±!');
                return;
            }

            if (expense.krw === 0 && expense.twd === 0) {
                showToast('Ë´ãËá≥Â∞ëÂ°´ÂØ´‰∏ÄÁ®ÆÈáëÈ°ç!');
                return;
            }

            if (editingExpenseId) {
                const index = expenses.findIndex(e => e.id === editingExpenseId);
                if (index !== -1) {
                    expenses[index] = expense;
                    showToast('Ë®òÂ∏≥Â∑≤Êõ¥Êñ∞!');
                }
                editingExpenseId = null;
            } else {
                expenses.push(expense);
                showToast('Ë®òÂ∏≥ÊàêÂäü!');
            }
            
            expenses.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            saveToStorage();
            resetForm();
            renderExpenses();
        }

        function resetForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('krw').value = '';
            document.getElementById('twd').value = '';
            document.getElementById('note').value = '';
            document.querySelector('input[name="category"][value="È£ü"]').checked = true;
            document.querySelector('input[name="payment"][value="ÁèæÈáë"]').checked = true;
            document.querySelector('input[name="mainMode"][value="split"]').checked = true;
            document.querySelector('input[name="splitMethod"][value="equal"]').checked = true;
            document.getElementById('splitSubMode').style.display = 'block';
            document.getElementById('enableSplit').checked = false;
            document.getElementById('splitContent').style.display = 'none';
            document.getElementById('formModeTitle').textContent = 'Êñ∞Â¢ûË®òÂ∏≥';
            splitPeople = [];
            splitAllocations = {};
            renderSplitPeople();
            renderSplitAllocations();
            updateSplitPreview();
            setCurrentDateTime();
            editingExpenseId = null;
        }

        function renderExpenses() {
            const container = document.getElementById('expenseList');
            
            let displayList = expenses;
            if (currentExpenseFilter) {
                displayList = filterExpenses(currentExpenseFilter);
            }
            
            // ===== 1. Ë®àÁÆóÁ∏ΩÊîØÂá∫Áµ±Ë®à (‰ΩøÁî®ÂÖ®ÈÉ®Ë®òÂ∏≥,‰∏çÂèóÁØ©ÈÅ∏ÂΩ±Èüø) =====
            let totalKRW = 0;  // ÂØ¶ÈöõÊîØÂá∫ (‰∏çÂê´ÂÑ≤ÂÄº)
            let totalTWD = 0;  // ÂØ¶ÈöõÊîØÂá∫ (‰∏çÂê´ÂÑ≤ÂÄº)
            let topupKRW = 0;  // ÂÑ≤ÂÄºÈáëÈ°ç
            
            expenses.forEach(e => {  // Ê≥®ÊÑèÈÄôË£°Áî® expenses ËÄåÈùû displayList
                const totalK = Number(e.krw) || 0;
                const totalT = Number(e.twd) || 0;
                
                // ÊéíÈô§„ÄåÂÑ≤ÂÄº„ÄçÂàÜÈ°û (ÈÄôÊâçÊòØÁúüÊ≠£Ë¶ÅÊéíÈô§ÁöÑ)
                if (e.category === 'ÂÑ≤ÂÄº') {
                    topupKRW += totalK;
                    return;
                }

                if (!e.split || !e.splitPeople || e.splitPeople.length === 0) {
                    totalKRW += totalK;
                    totalTWD += totalT;
                    return;
                }

                const mode = e.splitMode || 'split';
                const method = e.splitMethod || 'equal';

                if (mode === 'split' && method === 'equal') {
                    const denom = (e.splitPeople.length + 1);
                    totalKRW += denom > 0 ? totalK / denom : 0;
                    totalTWD += denom > 0 ? totalT / denom : 0;
                    return;
                }

                // proxy Êàñ split+customÔºöÁî® splitAllocations Âä†Á∏Ω
                const alloc = e.splitAllocations || {};
                let otherKRW = 0;
                let otherTWD = 0;

                e.splitPeople.forEach(p => {
                    const a = alloc[p] || { krw: 0, twd: 0 };
                    otherKRW += Number(a.krw) || 0;
                    otherTWD += Number(a.twd) || 0;
                });

                totalKRW += (totalK - otherKRW);
                totalTWD += (totalT - otherTWD);
            });

            // Êõ¥Êñ∞Á∏ΩÊîØÂá∫Áµ±Ë®àÈ°ØÁ§∫
            document.getElementById('totalKRW').textContent = '‚Ç©' + Math.round(totalKRW).toLocaleString();
            document.getElementById('totalTWD').textContent = 'NT$' + Math.round(totalTWD).toLocaleString();

            // ===== 2. Ë®àÁÆóÂàÜÈ°ûÁµ±Ë®à (‰ΩøÁî®ÂÖ®ÈÉ®Ë®òÂ∏≥,ÊéíÈô§ÂÑ≤ÂÄº) =====
            renderCategoryStats(expenses);  // ÊîπÁî® expenses ËÄåÈùû displayList

            if (displayList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-text">${currentExpenseFilter ? 'Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑ' : 'ÈÇÑÊ≤íÊúâË®òÂ∏≥Ë®òÈåÑ'}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = displayList.map((expense) => {
                const actualIndex = expenses.indexOf(expense);
                const date = new Date(expense.datetime);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                const icon = getCategoryIcon(expense.category);
                
                let splitInfo = '';
                if (expense.split && expense.splitPeople.length > 0) {
                    if (expense.splitMode === 'proxy') {
                        splitInfo = `<span>üéÅ ‰ª£Ë≥ºÁµ¶ ${expense.splitPeople.join(', ')}</span>`;
                    } else {
                        const perPersonKRW = Math.round(expense.krw / (expense.splitPeople.length + 1));
                        const perPersonTWD = Math.round(expense.twd / (expense.splitPeople.length + 1));
                        splitInfo = `<span>üë• Ëàá ${expense.splitPeople.join(', ')} Âπ≥ÂàÜ (ÊØè‰∫∫ ‚Ç©${perPersonKRW.toLocaleString()} / NT$${perPersonTWD.toLocaleString()})</span>`;
                    }
                }
                
                return `
                    <div class="expense-card">
                        <div class="expense-header">
                            <div class="expense-title">
                                <span>${icon}</span>
                                <span>${expense.itemName}</span>
                                ${expense.settled ? '<span class="settled-badge">Â∑≤ÁµêÊ∏Ö</span>' : ''}
                                ${expense.splitMode === 'proxy' ? '<span class="proxy-badge">‰ª£Ë≥º</span>' : ''}
                            </div>
                            <div class="expense-menu">
                                <button class="expense-menu-btn" onclick="toggleExpenseMenu(${actualIndex})">‚ãØ</button>
                                <div class="expense-dropdown" id="menu-${actualIndex}">
                                    <button onclick="editExpense(${actualIndex})">‚úèÔ∏è Á∑®ËºØ</button>
                                    <button onclick="toggleSettle(${actualIndex})">
                                        ${expense.settled ? '‚Ü©Ô∏è ÂèñÊ∂àÁµêÊ∏Ö' : '‚úì Ê®ôË®òÁµêÊ∏Ö'}
                                    </button>
                                    <button onclick="deleteExpense(${actualIndex})" style="color: #E74C3C;">üóëÔ∏è Âà™Èô§</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="expense-date">${dateStr}</div>
                        
                        ${expense.note ? `<div style="font-size: 13px; color: var(--text-gray); margin: 8px 0;">üìå ${expense.note}</div>` : ''}
                        
                        <div class="expense-amounts">
                            <div class="amount-item">
                                <div class="amount-label">ÈüìÂÖÉ</div>
                                <div class="amount-value">‚Ç©${expense.krw.toLocaleString()}</div>
                            </div>
                            <div class="amount-item">
                                <div class="amount-label">Âè∞Âπ£</div>
                                <div class="amount-value">NT$${expense.twd.toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 12px; font-size: 13px; color: var(--text-gray); flex-wrap: wrap;">
                            <span>üí≥ ${expense.payment}</span>
                            ${splitInfo}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCategoryStats(dataList) {
            const container = document.getElementById('categoryStats');
            if (!container) return;

            // Ë®àÁÆóÊØèÂÄãÂàÜÈ°ûÁöÑÊîØÂá∫ (ÊéíÈô§ÂÑ≤ÂÄº)
            const categoryTotals = {
                'È£ü': { krw: 0, twd: 0, count: 0, icon: 'üçΩÔ∏è', color: '#FF6B6B' },
                'Ë°£': { krw: 0, twd: 0, count: 0, icon: 'üëï', color: '#4ECDC4' },
                '‰Ωè': { krw: 0, twd: 0, count: 0, icon: 'üè®', color: '#45B7D1' },
                'Ë°å': { krw: 0, twd: 0, count: 0, icon: 'üöá', color: '#FFA07A' },
                'Ê®Ç': { krw: 0, twd: 0, count: 0, icon: 'üé™', color: '#98D8C8' },
                'ÂÖ∂‰ªñ': { krw: 0, twd: 0, count: 0, icon: 'üì¶', color: '#95A5A6' }
            };

            dataList.forEach(e => {
                const category = e.category;
                
                // ‚≠ê ÊéíÈô§ÂÑ≤ÂÄºÂàÜÈ°û
                if (category === 'ÂÑ≤ÂÄº') return;
                
                if (!categoryTotals[category]) return;

                categoryTotals[category].count++;

                const totalK = Number(e.krw) || 0;
                const totalT = Number(e.twd) || 0;

                if (!e.split || !e.splitPeople || e.splitPeople.length === 0) {
                    categoryTotals[category].krw += totalK;
                    categoryTotals[category].twd += totalT;
                    return;
                }

                const mode = e.splitMode || 'split';
                const method = e.splitMethod || 'equal';

                if (mode === 'split' && method === 'equal') {
                    const denom = e.splitPeople.length + 1;
                    categoryTotals[category].krw += denom > 0 ? totalK / denom : 0;
                    categoryTotals[category].twd += denom > 0 ? totalT / denom : 0;
                    return;
                }

                // proxy Êàñ split+custom
                const alloc = e.splitAllocations || {};
                let otherKRW = 0;
                let otherTWD = 0;

                e.splitPeople.forEach(p => {
                    const a = alloc[p] || { krw: 0, twd: 0 };
                    otherKRW += Number(a.krw) || 0;
                    otherTWD += Number(a.twd) || 0;
                });

                categoryTotals[category].krw += (totalK - otherKRW);
                categoryTotals[category].twd += (totalT - otherTWD);
            });

            // Âè™È°ØÁ§∫ÊúâÊîØÂá∫ÁöÑÂàÜÈ°û,‰∏¶ÊåâÈáëÈ°çÊéíÂ∫è
            const sortedCategories = Object.entries(categoryTotals)
                .filter(([_, data]) => data.count > 0)
                .sort((a, b) => b[1].krw - a[1].krw);

            if (sortedCategories.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">Êö´ÁÑ°ÂàÜÈ°ûÁµ±Ë®à</div>';
                return;
            }

            // ‰øùÂ≠òÊï∏Êìö‰æõÂúìÈ§ÖÂúñ‰ΩøÁî®
            window.categoryChartData = sortedCategories;

            // Ê©´Âêë6Ê†º‰ΩàÂ±Ä
            container.innerHTML = sortedCategories.map(([category, data]) => `
                <div style="display: flex; flex-direction: column; align-items: center; padding: 12px; background: #F8F9FA; border-radius: 12px; border-top: 3px solid ${data.color}; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <div style="font-size: 32px; margin-bottom: 8px;">${data.icon}</div>
                    <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">${category}</div>
                    <div style="font-size: 16px; font-weight: 700; color: ${data.color};">‚Ç©${Math.round(data.krw).toLocaleString()}</div>
                    ${data.twd > 0 ? `<div style="font-size: 11px; color: var(--text-gray); margin-top: 2px;">NT$${Math.round(data.twd).toLocaleString()}</div>` : ''}
                    <div style="font-size: 11px; color: var(--text-gray); margin-top: 4px;">${data.count} Á≠Ü</div>
                </div>
            `).join('');
            
            // Ë®≠ÂÆöÂÆπÂô®Ê®£ÂºèÁÇ∫ 6 Ê¨Ñ grid
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(3, 1fr)';
            container.style.gap = '10px';
        }

        function toggleExpenseMenu(index) {
            const radius = 80;
            
            // Ê∏ÖÈô§Áï´Â∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (sortedCategories.length === 0) {
                // È°ØÁ§∫Á©∫ÁãÄÊÖã
                ctx.fillStyle = '#E8ECF0';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.fill();
                ctx.fillStyle = '#95A5A6';
                ctx.font = '14px "Noto Sans TC"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Êö´ÁÑ°Êï∏Êìö', centerX, centerY);
                return;
            }
            
            const total = sortedCategories.reduce((sum, [_, data]) => sum + data.krw, 0);
            let currentAngle = -Math.PI / 2;  // ÂæûÈ†ÇÈÉ®ÈñãÂßã
            
            sortedCategories.forEach(([category, data]) => {
                const sliceAngle = (data.krw / total) * 2 * Math.PI;
                
                // Áπ™Ë£ΩÊâáÂΩ¢
                ctx.fillStyle = data.color;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();
                
                // Áπ™Ë£ΩÁôΩËâ≤ÈÇäÊ°Ü
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
            });
            
            // ‰∏≠ÂøÉÁôΩËâ≤ÂúìÂúà (ÁîúÁîúÂúàÊïàÊûú)
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
            ctx.fill();
        }

        function toggleExpenseMenu(index) {
            const menu = document.getElementById(`menu-${index}`);
            const allMenus = document.querySelectorAll('.expense-dropdown');
            
            allMenus.forEach(m => {
                if (m.id !== `menu-${index}`) {
                    m.classList.remove('show');
                }
            });
            
            menu.classList.toggle('show');
        }

        function toggleSettle(index) {
            expenses[index].settled = !expenses[index].settled;
            saveToStorage();
            renderExpenses();
            document.querySelectorAll('.expense-dropdown').forEach(m => m.classList.remove('show'));
        }

        function editExpense(index) {
            const expense = expenses[index];
            editingExpenseId = expense.id;
            
            document.getElementById('datetime').value = expense.datetime;
            document.getElementById('itemName').value = expense.itemName;
            document.querySelector(`input[name="category"][value="${expense.category}"]`).checked = true;
            document.getElementById('krw').value = expense.krw || '';
            document.getElementById('twd').value = expense.twd || '';
            document.querySelector(`input[name="payment"][value="${expense.payment}"]`).checked = true;
            document.getElementById('note').value = expense.note || '';
            document.getElementById('formModeTitle').textContent = 'Á∑®ËºØË®òÂ∏≥';
            
            if (expense.split) {
                document.getElementById('enableSplit').checked = true;
                document.getElementById('splitContent').style.display = 'block';
                
                // Ë®≠ÂÆöÂàÜÂ∏≥Ê®°Âºè radio button
                const splitMode = expense.splitMode || 'split';
                const splitMethod = expense.splitMethod || 'equal';
                
                document.querySelector(`input[name="mainMode"][value="${splitMode}"]`).checked = true;
                
                if (splitMode === 'split') {
                    document.getElementById('splitSubMode').style.display = 'block';
                    document.querySelector(`input[name="splitMethod"][value="${splitMethod}"]`).checked = true;
                } else {
                    document.getElementById('splitSubMode').style.display = 'none';
                }
                
                splitPeople = [...expense.splitPeople];
                renderSplitPeople();
                
                // ‚≠ê ÈáçË¶Å: ËºâÂÖ•Ëá™Ë®ÇÈáëÈ°çË≥áÊñô
                if (expense.splitAllocations) {
                    splitAllocations = JSON.parse(JSON.stringify(expense.splitAllocations));
                } else {
                    splitAllocations = {};
                }
                
                renderSplitAllocations();
                updateSplitPreview();
            } else {
                splitPeople = [];
                splitAllocations = {};
            }
            
            document.querySelector('.tab[data-tab="expense"]').click();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            document.querySelectorAll('.expense-dropdown').forEach(m => m.classList.remove('show'));
            
            showToast('Á∑®ËºØÊ®°Âºè - ‰øÆÊîπÂæåÈªûÂÑ≤Â≠ò');
        }

        function deleteExpense(index) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÂ∏≥Âóé?')) {
                expenses.splice(index, 1);
                saveToStorage();
                renderExpenses();
                showToast('Ë®òÂ∏≥Â∑≤Âà™Èô§');
            }
            document.querySelectorAll('.expense-dropdown').forEach(m => m.classList.remove('show'));
        }

        // ========== ÁØ©ÈÅ∏ÂäüËÉΩ ==========
        
        function switchFilter(type) {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const content = document.getElementById('filterContent');
            
            if (type === 'all') {
                content.innerHTML = '';
                clearExpenseFilter();
                return;
            }
            
            if (type === 'category') {
                content.innerHTML = `
                    <div class="filter-options">
                        <button class="filter-option-btn" onclick="filterByCategory('È£ü')">üçΩÔ∏è È£ü</button>
                        <button class="filter-option-btn" onclick="filterByCategory('Ë°£')">üëï Ë°£</button>
                        <button class="filter-option-btn" onclick="filterByCategory('‰Ωè')">üè® ‰Ωè</button>
                        <button class="filter-option-btn" onclick="filterByCategory('Ë°å')">üöá Ë°å</button>
                        <button class="filter-option-btn" onclick="filterByCategory('Ê®Ç')">üé™ Ê®Ç</button>
                        <button class="filter-option-btn" onclick="filterByCategory('ÂÑ≤ÂÄº')">üí∞ ÂÑ≤ÂÄº</button>
                        <button class="filter-option-btn" onclick="filterByCategory('ÂÖ∂‰ªñ')">üì¶ ÂÖ∂‰ªñ</button>
                    </div>
                `;
            } else if (type === 'date') {
                const dates = [...new Set(expenses.map(e => {
                    const d = new Date(e.datetime);
                    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                }))].sort().reverse();
                
                content.innerHTML = `
                    <select id="dateSelect" onchange="filterByDate()" style="width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #E8ECF0;">
                        <option value="">ÈÅ∏ÊìáÊó•Êúü</option>
                        ${dates.map(date => `<option value="${date}">${date}</option>`).join('')}
                    </select>
                `;
            } else if (type === 'payment') {
                content.innerHTML = `
                    <div class="filter-options">
                        <button class="filter-option-btn" onclick="filterByPayment('ÁèæÈáë')">ÁèæÈáë</button>
                        <button class="filter-option-btn" onclick="filterByPayment('‰ø°Áî®Âç°')">‰ø°Áî®Âç°</button>
                        <button class="filter-option-btn" onclick="filterByPayment('ÈõªÂ≠êÊîØ‰ªò')">ÈõªÂ≠êÊîØ‰ªò</button>
                        <button class="filter-option-btn" onclick="filterByPayment('TM/WP')">TM/WP</button>
                    </div>
                `;
            }
        }

        function filterByCategory(category) {
            currentExpenseFilter = { type: 'category', value: category };
            document.getElementById('clearExpenseBtn').style.display = 'block';
            renderExpenses();
        }

        function filterByDate() {
            const date = document.getElementById('dateSelect').value;
            if (!date) {
                clearExpenseFilter();
                return;
            }
            currentExpenseFilter = { type: 'date', value: date };
            document.getElementById('clearExpenseBtn').style.display = 'block';
            renderExpenses();
        }

        function filterByPayment(payment) {
            currentExpenseFilter = { type: 'payment', value: payment };
            document.getElementById('clearExpenseBtn').style.display = 'block';
            renderExpenses();
        }

        function filterExpenses(filter) {
            if (!filter) return expenses;
            
            if (filter.type === 'category') {
                return expenses.filter(e => e.category === filter.value);
            } else if (filter.type === 'date') {
                return expenses.filter(e => {
                    const d = new Date(e.datetime);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    return dateStr === filter.value;
                });
            } else if (filter.type === 'payment') {
                return expenses.filter(e => e.payment === filter.value);
            }
            return expenses;
        }

        function clearExpenseFilter() {
            currentExpenseFilter = null;
            document.getElementById('clearExpenseBtn').style.display = 'none';
            document.getElementById('filterContent').innerHTML = '';
            renderExpenses();
        }
        // ========== Ë≥ºÁâ©Ê∏ÖÂñÆÂäüËÉΩ ==========
        
        function previewShoppingImage() {
            const file = document.getElementById('shoppingImage').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                document.getElementById('imagePreview').innerHTML = `<img src="${currentImageData}" alt="preview">`;
            };
            reader.readAsDataURL(file);
        }

        function addShoppingItem() {
            const item = document.getElementById('shoppingItem').value.trim();
            
            if (!item) {
                showToast('Ë´ãËº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±');
                return;
            }

            const shopping = {
                id: editingShoppingId || Date.now(),
                image: currentImageData,
                item: item,
                location: document.getElementById('shoppingLocation').value.trim(),
                targetQty: parseInt(document.getElementById('shoppingTargetQty').value) || 1,
                purchasedQty: 0,
                krw: parseFloat(document.getElementById('shoppingKRW').value) || 0,
                twd: parseFloat(document.getElementById('shoppingTWD').value) || 0,
                note: document.getElementById('shoppingNote').value.trim(),
                purchased: false
            };

            if (editingShoppingId) {
                const index = shoppingList.findIndex(s => s.id === editingShoppingId);
                if (index !== -1) {
                    shoppingList[index] = {
                        ...shopping,
                        purchasedQty: shoppingList[index].purchasedQty
                    };
                    showToast('ÂïÜÂìÅÂ∑≤Êõ¥Êñ∞!');
                }
                editingShoppingId = null;
            } else {
                shoppingList.push(shopping);
                showToast('Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ê∏ÖÂñÆ');
            }

            saveShopping();
            renderShopping();
            updateLocationFilters();
            resetShoppingForm();
        }

        function resetShoppingForm() {
            document.getElementById('shoppingItem').value = '';
            document.getElementById('shoppingLocation').value = '';
            document.getElementById('shoppingTargetQty').value = '1';
            document.getElementById('shoppingKRW').value = '';
            document.getElementById('shoppingTWD').value = '';
            document.getElementById('shoppingNote').value = '';
            document.getElementById('shoppingImage').value = '';
            document.getElementById('shoppingFormModeTitle').textContent = 'Êñ∞Â¢ûÂïÜÂìÅ';
            document.getElementById('imagePreview').innerHTML = `
                <div class="upload-placeholder">
                    <span style="font-size: 48px;">üì∑</span>
                    <div style="margin-top: 8px; font-size: 14px;">ÈªûÊìä‰∏äÂÇ≥ÂúñÁâá</div>
                </div>
            `;
            currentImageData = null;
            editingShoppingId = null;
        }

        function editShopping(index) {
            const shopping = shoppingList[index];
            editingShoppingId = shopping.id;
            
            document.getElementById('shoppingItem').value = shopping.item;
            document.getElementById('shoppingLocation').value = shopping.location || '';
            document.getElementById('shoppingTargetQty').value = shopping.targetQty || 1;
            document.getElementById('shoppingKRW').value = shopping.krw || '';
            document.getElementById('shoppingTWD').value = shopping.twd || '';
            document.getElementById('shoppingNote').value = shopping.note || '';
            document.getElementById('shoppingFormModeTitle').textContent = 'Á∑®ËºØÂïÜÂìÅ';
            
            if (shopping.image) {
                document.getElementById('imagePreview').innerHTML = `<img src="${shopping.image}" alt="preview">`;
                currentImageData = shopping.image;
            }
            
            document.querySelector('.tab[data-tab="shopping"]').click();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showToast('Á∑®ËºØÊ®°Âºè - ‰øÆÊîπÂæåÈªûÂÑ≤Â≠ò');
        }

        function renderShopping() {
            const container = document.getElementById('shoppingList');
            const statsCard = document.getElementById('shoppingStatsCard');
            const statsGrid = document.getElementById('shoppingStats');
            
            let displayList = shoppingList;
            if (currentShoppingFilter) {
                displayList = shoppingList.filter(s => s.location === currentShoppingFilter);
            }
            
            const total = displayList.length;
            const purchased = displayList.filter(s => {
                const targetQty = s.targetQty || 0;
                const purchasedQty = s.purchasedQty || 0;
                return s.purchased || (targetQty > 0 && purchasedQty >= targetQty);
            }).length;
            
            const totalKRW = displayList.reduce((sum, s) => {
                const qty = s.targetQty || 1;
                return sum + (s.krw * qty);
            }, 0);
            const totalTWD = displayList.reduce((sum, s) => {
                const qty = s.targetQty || 1;
                return sum + (s.twd * qty);
            }, 0);
            
            if (shoppingList.length > 0) {
                statsCard.style.display = 'block';
                statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-label">${currentShoppingFilter ? 'ÁØ©ÈÅ∏ÁµêÊûú' : 'Á∏ΩÊï∏'}</div>
                        <div class="stat-value">${total} È†Ö</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Â∑≤ÂÆåÊàê</div>
                        <div class="stat-value">${purchased} È†Ö</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">È†ê‰º∞ÈüìÂÖÉ</div>
                        <div class="stat-value">‚Ç©${Math.round(totalKRW).toLocaleString()}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">È†ê‰º∞Âè∞Âπ£</div>
                        <div class="stat-value">NT$${Math.round(totalTWD).toLocaleString()}</div>
                    </div>
                `;
            } else {
                statsCard.style.display = 'none';
            }

            if (displayList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üõçÔ∏è</div>
                        <div class="empty-text">${currentShoppingFilter ? 'Ê≠§Âú∞ÈªûÊ≤íÊúâÂïÜÂìÅ' : 'Ë≥ºÁâ©Ê∏ÖÂñÆÊòØÁ©∫ÁöÑ'}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = displayList.map((shopping) => {
                const actualIndex = shoppingList.indexOf(shopping);
                const targetQty = shopping.targetQty || 0;
                const purchasedQty = shopping.purchasedQty || 0;
                const isComplete = targetQty > 0 && purchasedQty >= targetQty;
                const purchasedClass = shopping.purchased || isComplete ? 'purchased' : '';
                const progress = targetQty > 0 ? Math.min((purchasedQty / targetQty * 100), 100) : 0;
                
                return `
                    <div class="shopping-card ${purchasedClass}">
                        ${shopping.image ? `<img src="${shopping.image}" class="shopping-image" alt="${shopping.item}">` : ''}
                        <div class="shopping-content">
                            <div class="shopping-header">
                                <div class="shopping-title ${purchasedClass}">
                                    ${shopping.item}
                                </div>
                            </div>
                            
                            ${shopping.location ? `<div class="shopping-info">üìç ${shopping.location}</div>` : ''}
                            
                            ${targetQty > 0 ? `
                                <div class="shopping-quantity">
                                    <div class="qty-info">
                                        <span>ÈÄ≤Â∫¶: ${purchasedQty} / ${targetQty}</span>
                                        <span class="qty-badge ${isComplete ? 'complete' : ''}">${isComplete ? '‚úì Â∑≤Ë≤∑ÈΩä' : 'ÈÄ≤Ë°å‰∏≠'}</span>
                                    </div>
                                    <div class="qty-progress">
                                        <div class="qty-progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                    
                                    <div style="margin-top: 12px;">
                                        <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 4px;">Â∑≤Ë≥ºË≤∑Êï∏Èáè</div>
                                        <div class="qty-actions">
                                            <button class="qty-btn" onclick="updatePurchasedQty(${actualIndex}, -1)">Ôºç</button>
                                            <span>${purchasedQty}</span>
                                            <button class="qty-btn" onclick="updatePurchasedQty(${actualIndex}, 1)">Ôºã</button>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 8px;">
                                        <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 4px;">ÁõÆÊ®ôÊï∏Èáè</div>
                                        <div class="qty-actions">
                                            <button class="qty-btn" onclick="updateTargetQty(${actualIndex}, -1)">Ôºç</button>
                                            <span>${targetQty}</span>
                                            <button class="qty-btn" onclick="updateTargetQty(${actualIndex}, 1)">Ôºã</button>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${(shopping.krw > 0 || shopping.twd > 0) ? `
                                <div class="shopping-prices">
                                    ${shopping.krw > 0 ? `<span>ÂñÆÂÉπ ‚Ç©${shopping.krw.toLocaleString()}${targetQty > 1 ? ` √ó ${targetQty} = ‚Ç©${(shopping.krw * targetQty).toLocaleString()}` : ''}</span>` : ''}
                                    ${shopping.twd > 0 ? `<span>ÂñÆÂÉπ NT$${shopping.twd.toLocaleString()}${targetQty > 1 ? ` √ó ${targetQty} = NT$${(shopping.twd * targetQty).toLocaleString()}` : ''}</span>` : ''}
                                </div>
                            ` : ''}
                            
                            ${shopping.note ? `<div class="shopping-info">üìå ${shopping.note}</div>` : ''}
                            
                            <div class="shopping-actions">
                                <button class="btn-purchase ${shopping.purchased || isComplete ? 'purchased' : ''}" onclick="togglePurchase(${actualIndex})">
                                    ${shopping.purchased || isComplete ? '‚úì Â∑≤Ë≥ºË≤∑' : 'Ê®ôË®òÂ∑≤Ë≥ºË≤∑'}
                                </button>
                                <button class="btn-icon edit" onclick="editShopping(${actualIndex})">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="deleteShopping(${actualIndex})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePurchasedQty(index, change) {
            const item = shoppingList[index];
            const newQty = (item.purchasedQty || 0) + change;
            
            if (newQty < 0) return;
            
            shoppingList[index].purchasedQty = newQty;
            
            if (item.targetQty && newQty >= item.targetQty) {
                shoppingList[index].purchased = true;
            } else if (newQty < item.targetQty) {
                shoppingList[index].purchased = false;
            }
            
            saveShopping();
            renderShopping();
        }

        function updateTargetQty(index, change) {
            const item = shoppingList[index];
            const newQty = (item.targetQty || 0) + change;
            
            if (newQty < 1) return;
            
            shoppingList[index].targetQty = newQty;
            saveShopping();
            renderShopping();
        }

        function togglePurchase(index) {
            shoppingList[index].purchased = !shoppingList[index].purchased;
            saveShopping();
            renderShopping();
        }

        function deleteShopping(index) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÂïÜÂìÅÂóé?')) {
                shoppingList.splice(index, 1);
                saveShopping();
                renderShopping();
                updateLocationFilters();
                showToast('Â∑≤ÂæûË≥ºÁâ©Ê∏ÖÂñÆÁßªÈô§');
            }
        }

        function updateLocationFilters() {
            const filterCard = document.getElementById('locationFilterCard');
            const container = document.getElementById('locationFilters');
            
            const locations = [...new Set(shoppingList.map(s => s.location).filter(l => l))];
            
            if (locations.length === 0) {
                filterCard.style.display = 'none';
                return;
            }
            
            filterCard.style.display = 'block';
            
            container.innerHTML = locations.map(location => {
                const count = shoppingList.filter(s => s.location === location).length;
                const activeClass = currentShoppingFilter === location ? 'active' : '';
                return `
                    <button class="location-btn ${activeClass}" onclick="filterByLocation('${location}')">
                        üìç ${location} (${count})
                    </button>
                `;
            }).join('');
        }

        function filterByLocation(location) {
            if (currentShoppingFilter === location) {
                clearShoppingFilter();
                return;
            }
            
            currentShoppingFilter = location;
            document.getElementById('clearShoppingBtn').style.display = 'block';
            updateLocationFilters();
            renderShopping();
        }

        function clearShoppingFilter() {
            currentShoppingFilter = null;
            document.getElementById('clearShoppingBtn').style.display = 'none';
            updateLocationFilters();
            renderShopping();
        }

        // ========== ÂàÜÂ∏≥Áµ±Ë®à ==========
        
        function renderSplitReport() {
            const container = document.getElementById('splitReportContent');
            const splitExpenses = expenses.filter(e => e.split && e.splitPeople.length > 0);
            
            if (splitExpenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div class="empty-text">ÁõÆÂâçÊ≤íÊúâÂàÜÂ∏≥Ë®òÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            const peopleStats = {};
            
            splitExpenses.forEach(expense => {
                if (expense.splitMode === 'proxy') {
                    // ‰ª£Ë≥ºÊ®°Âºè:ÂÖ®È°çÁÆóÂ∞çÊñπÁöÑ
                    expense.splitPeople.forEach(person => {
                        if (!peopleStats[person]) {
                            peopleStats[person] = {
                                name: person,
                                totalKRW: 0,
                                totalTWD: 0,
                                count: 0,
                                expenses: []
                            };
                        }
                        
                        peopleStats[person].totalKRW += expense.krw;
                        peopleStats[person].totalTWD += expense.twd;
                        peopleStats[person].count += 1;
                        peopleStats[person].expenses.push({
                            item: expense.itemName,
                            krw: expense.krw,
                            twd: expense.twd,
                            datetime: expense.datetime,
                            type: '‰ª£Ë≥º'
                        });
                    });
                } else {
                    // Âπ≥ÂàÜÊ®°Âºè
                    const totalPeople = expense.splitPeople.length + 1;
                    const perPersonKRW = expense.krw / totalPeople;
                    const perPersonTWD = expense.twd / totalPeople;
                    
                    expense.splitPeople.forEach(person => {
                        if (!peopleStats[person]) {
                            peopleStats[person] = {
                                name: person,
                                totalKRW: 0,
                                totalTWD: 0,
                                count: 0,
                                expenses: []
                            };
                        }
                        
                        peopleStats[person].totalKRW += perPersonKRW;
                        peopleStats[person].totalTWD += perPersonTWD;
                        peopleStats[person].count += 1;
                        peopleStats[person].expenses.push({
                            item: expense.itemName,
                            krw: Math.round(perPersonKRW),
                            twd: Math.round(perPersonTWD),
                            datetime: expense.datetime,
                            type: 'Âπ≥ÂàÜ'
                        });
                    });
                }
            });
            
            const sortedPeople = Object.values(peopleStats).sort((a, b) => b.totalTWD - a.totalTWD);
            
            container.innerHTML = sortedPeople.map(person => {
                return `
                    <div class="split-card">
                        <div class="split-person-name">üë§ ${person.name}</div>
                        <div class="split-stats">
                            <div class="split-stat-row">
                                <span class="split-stat-label">ÂèÉËàáÊ¨°Êï∏</span>
                                <span class="split-stat-value">${person.count} Ê¨°</span>
                            </div>
                            <div class="split-stat-row">
                                <span class="split-stat-label">Êáâ‰ªòÈüìÂÖÉ</span>
                                <span class="split-stat-value">‚Ç©${Math.round(person.totalKRW).toLocaleString()}</span>
                            </div>
                            <div class="split-stat-row">
                                <span class="split-stat-label">Êáâ‰ªòÂè∞Âπ£</span>
                                <span class="split-stat-value">NT$${Math.round(person.totalTWD).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="split-details">
                            <div class="split-detail-title">ÊòéÁ¥∞:</div>
                            ${person.expenses.map(exp => {
                                const date = new Date(exp.datetime);
                                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                                return `<div class="split-item">‚Ä¢ ${dateStr} ${exp.item} [${exp.type}]: ‚Ç©${exp.krw.toLocaleString()} / NT$${exp.twd.toLocaleString()}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== ÂåØÂá∫ Excel ==========
        
        function exportToExcel() {
            if (expenses.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâË®òÂ∏≥Ë®òÈåÑÂèØ‰ª•ÂåØÂá∫');
                return;
            }

            let csvContent = '\uFEFF';
            csvContent += 'Êó•Êúü,ÊôÇÈñì,È†ÖÁõÆ,ÂàÜÈ°û,ÈüìÂÖÉ,Âè∞Âπ£,‰ªòÊ¨æÊñπÂºè,ÂàÜÂ∏≥Ê®°Âºè,ÂàÜÂ∏≥Â∞çË±°,ÂÇôË®ª,Â∑≤ÁµêÊ∏Ö\n';
            
            expenses.forEach(expense => {
                const date = new Date(expense.datetime);
                const dateStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                const splitMode = expense.split ? (expense.splitMode === 'proxy' ? '‰ª£Ë≥º' : 'Âπ≥ÂàÜ') : 'Âê¶';
                
                csvContent += [
                    dateStr,
                    timeStr,
                    `"${expense.itemName}"`,
                    expense.category,
                    expense.krw,
                    expense.twd,
                    expense.payment,
                    splitMode,
                    expense.split ? `"${expense.splitPeople.join(', ')}"` : '',
                    `"${expense.note || ''}"`,
                    expense.settled ? 'Â∑≤ÁµêÊ∏Ö' : 'Êú™ÁµêÊ∏Ö'
                ].join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const now = new Date();
            const filename = `ÈüìÂúãÊóÖË°åË®òÂ∏≥_${currentUser}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Â∑≤ÂåØÂá∫ Excel Ê™îÊ°à!');
        }

        // ========== Â∑•ÂÖ∑ÂáΩÊï∏ ==========
        
        function getCategoryIcon(category) {
            const icons = {
                'È£ü': 'üçΩÔ∏è',
                'Ë°£': 'üëï',
                '‰Ωè': 'üè®',
                'Ë°å': 'üöá',
                'Ê®Ç': 'üé™',
                'ÂÑ≤ÂÄº': 'üí∞',
                'ÂÖ∂‰ªñ': 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        // ÂúìÈ§ÖÂúñÂàáÊèõÂäüËÉΩ
        function togglePieChart() {
            const container = document.getElementById('pieChartContainer');
            const isVisible = container.style.display !== 'none';
            
            if (isVisible) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                renderPieChart();
            }
        }

        function renderPieChart() {
            const canvas = document.getElementById('categoryPieChart');
            if (!canvas || !window.categoryChartData) return;
            
            const ctx = canvas.getContext('2d');
            const data = window.categoryChartData;
            const total = data.reduce((sum, [_, d]) => sum + d.krw, 0);
            
            // Ê∏ÖÈô§Áï´Â∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;
            
            let currentAngle = -Math.PI / 2;
            
            data.forEach(([category, info]) => {
                const sliceAngle = (info.krw / total) * 2 * Math.PI;
                
                // Áπ™Ë£ΩÊâáÂΩ¢
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = info.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Áπ™Ë£ΩÁôæÂàÜÊØîÊñáÂ≠ó
                const percentage = ((info.krw / total) * 100).toFixed(1);
                if (percentage > 5) {  // Âè™È°ØÁ§∫Â§ßÊñº 5% ÁöÑÊ®ôÁ±§
                    const textAngle = currentAngle + sliceAngle / 2;
                    const textX = centerX + (radius * 0.7) * Math.cos(textAngle);
                    const textY = centerY + (radius * 0.7) * Math.sin(textAngle);
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px "Noto Sans TC"';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percentage}%`, textX, textY);
                }
                
                currentAngle += sliceAngle;
            });
            
            // Áπ™Ë£ΩÂúñ‰æã
            const legendY = canvas.height + 20;
            ctx.font = '12px "Noto Sans TC"';
            ctx.textAlign = 'left';
            
            data.forEach(([category, info], index) => {
                const x = (index % 3) * 90 + 10;
                const y = Math.floor(index / 3) * 20;
                
                ctx.fillStyle = info.color;
                ctx.fillRect(x, y, 12, 12);
                ctx.fillStyle = '#2C3E50';
                ctx.fillText(`${info.icon} ${category}`, x + 16, y + 10);
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--teal);
                color: white;
                padding: 16px 32px;
                border-radius: 50px;
                font-size: 15px;
                font-weight: 600;
                box-shadow: 0 4px 16px rgba(77, 184, 172, 0.4);
                z-index: 10000;
                animation: slideDown 0.3s ease;
            `;
            toast.textContent = '‚úÖ ' + message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2500);
        }

        // LocalStorage
        function saveToStorage() {
            localStorage.setItem(`koreaExpenses_${currentUser}`, JSON.stringify(expenses));
        }

        function loadExpenses() {
            const saved = localStorage.getItem(`koreaExpenses_${currentUser}`);
            if (saved) {
                expenses = JSON.parse(saved);
            } else {
                expenses = [];
            }
        }

        function saveShopping() {
            localStorage.setItem(`koreaShopping_${currentUser}`, JSON.stringify(shoppingList));
        }

        function loadShopping() {
            const saved = localStorage.getItem(`koreaShopping_${currentUser}`);
            if (saved) {
                shoppingList = JSON.parse(saved);
                shoppingList = shoppingList.map(item => ({
                    ...item,
                    targetQty: item.targetQty !== undefined ? item.targetQty : 0,
                    purchasedQty: item.purchasedQty !== undefined ? item.purchasedQty : 0
                }));
            } else {
                shoppingList = [];
            }
        }

        // ÂàùÂßãÂåñ
        init();
    </script>
</body>
</html>